name: Deploy Telegram Bot to Azure Container App

on:
  release:
    types: [prereleased, released]
  workflow_dispatch:

permissions: 
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set deployment info
        id: set_deployment_info
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/test" ]]; then
            echo "STAGE=test" >> $GITHUB_OUTPUT
            echo "CONTAINER_APP_NAME=container-app-bot-test" >> $GITHUB_OUTPUT
            echo "BOT_TOKEN_SECRET=test-bot-token" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "STAGE=staging" >> $GITHUB_OUTPUT
            echo "CONTAINER_APP_NAME=container-app-bot-staging" >> $GITHUB_OUTPUT
            echo "BOT_TOKEN_SECRET=bottoken" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/prod" ]]; then
            echo "STAGE=prod" >> $GITHUB_OUTPUT
            echo "CONTAINER_APP_NAME=container-app-bot-live" >> $GITHUB_OUTPUT
            echo "BOT_TOKEN_SECRET=bottoken" >> $GITHUB_OUTPUT
          else
            echo "STAGE=dev" >> $GITHUB_OUTPUT
            echo "CONTAINER_APP_NAME=container-app-bot-dev" >> $GITHUB_OUTPUT
            echo "BOT_TOKEN_SECRET=bottoken" >> $GITHUB_OUTPUT
          fi

          if [ "${{ github.event_name }}" == "release" ]; then
            echo "RELEASE_TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "RELEASE_TAG=manual-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

          echo "IMAGE_TAG=$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push image to ACR
        run: |
          az acr build --registry ca20a502fbd8acr \
            --image ${{ steps.set_deployment_info.outputs.CONTAINER_APP_NAME }}:${{ steps.set_deployment_info.outputs.IMAGE_TAG }} \
            --file Dockerfile .
      
      - name: Update Azure Container App
        run: |
          az containerapp update \
            --name ${{ steps.set_deployment_info.outputs.CONTAINER_APP_NAME }} \
            --resource-group container-app-rsgp \
            --image ca20a502fbd8acr.azurecr.io/${{ steps.set_deployment_info.outputs.CONTAINER_APP_NAME }}:${{ steps.set_deployment_info.outputs.IMAGE_TAG }} \
            --set-env-vars RELEASE_TAG=${{ steps.set_deployment_info.outputs.RELEASE_TAG }} STAGE=${{ steps.set_deployment_info.outputs.STAGE }} PYTHONUNBUFFERED=1

      - name: Ensure single active revision
        run: |
          az containerapp revision list -n ${{ steps.set_deployment_info.outputs.CONTAINER_APP_NAME }} -g container-app-rsgp --query "[?!active].name" -o tsv | xargs -I {} az containerapp revision deactivate -n ${{ steps.set_deployment_info.outputs.CONTAINER_APP_NAME }} -g container-app-rsgp --revision {}