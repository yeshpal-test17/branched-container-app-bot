name: Deploy Telegram Bot to Azure Container App

on:
  release:
    types: [prereleased, released]
  push:
    branches: [develop, test, master, pre-prod, prod]
  pull_request:
    types: [closed]
    branches: [master, prod]
  workflow_dispatch:

permissions: 
  contents: read

env:
  ACR_NAME: ca20a502fbd8acr
  RESOURCE_GROUP: container-app-rsgp
  CONTAINER_APP_NAME: branched-container-app-bot

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # Add environment protection for master and prod
    environment: ${{ github.ref == 'refs/heads/prod' && 'production' || github.ref == 'refs/heads/master' && 'staging' || 'development' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Add validation step for protected branches
      - name: Validate deployment conditions
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/prod'
        run: |
          # Check if the deployment is happening during business hours (example)
          HOUR=$(date +%H)
          DAY=$(date +%u)
          if [[ $DAY -gt 5 ]] || [[ $HOUR -lt 9 ]] || [[ $HOUR -gt 17 ]]; then
            echo "Deployments to master/prod are only allowed during business hours (Mon-Fri, 9 AM - 5 PM)"
            [[ ${{ github.event_name }} == 'workflow_dispatch' ]] || exit 1
          fi

      - name: Set deployment info
        id: set_deployment_info
        run: |
            # For releases, use the target branch instead of the tag ref
            if [ "${{ github.event_name }}" == "release" ]; then
              BRANCH_REF="refs/heads/${{ github.event.release.target_commitish }}"
              TAG_NAME="${{ github.event.release.tag_name }}"
              # Remove any prefix if it exists
              TAG_NAME="${TAG_NAME#beta-}"
              TAG_NAME="${TAG_NAME#alpha-}"
            else
              BRANCH_REF="${{ github.ref }}"
            fi
  
            # Set stage and container name based on branch
            if [[ "$BRANCH_REF" == "refs/heads/test" ]]; then
              echo "STAGE=test" >> $GITHUB_OUTPUT
              echo "CONTAINER_NAME=container-app-bot-test" >> $GITHUB_OUTPUT
              echo "BOT_TOKEN_SECRET=test-bot-token" >> $GITHUB_OUTPUT
              echo "DEPLOYMENT_SLOT=test" >> $GITHUB_OUTPUT
            elif [[ "$BRANCH_REF" == "refs/heads/master" ]]; then
              echo "STAGE=staging" >> $GITHUB_OUTPUT
              echo "CONTAINER_NAME=container-app-bot-staging" >> $GITHUB_OUTPUT
              echo "BOT_TOKEN_SECRET=staging-bot-token" >> $GITHUB_OUTPUT
              echo "DEPLOYMENT_SLOT=staging" >> $GITHUB_OUTPUT
            elif [[ "$BRANCH_REF" == "refs/heads/prod" ]]; then
              echo "STAGE=prod" >> $GITHUB_OUTPUT
              echo "CONTAINER_NAME=container-app-bot-live" >> $GITHUB_OUTPUT
              echo "BOT_TOKEN_SECRET=prod-bot-token" >> $GITHUB_OUTPUT
              echo "DEPLOYMENT_SLOT=production" >> $GITHUB_OUTPUT
            else
              echo "STAGE=dev" >> $GITHUB_OUTPUT
              echo "CONTAINER_NAME=container-app-bot-dev" >> $GITHUB_OUTPUT
              echo "BOT_TOKEN_SECRET=dev-bot-token" >> $GITHUB_OUTPUT
              echo "DEPLOYMENT_SLOT=development" >> $GITHUB_OUTPUT
            fi
  
            # Set release tag based on event type and branch
            if [ "${{ github.event_name }}" == "release" ]; then
              if [[ "$BRANCH_REF" == "refs/heads/master" ]]; then
                echo "RELEASE_TAG=staging-${TAG_NAME}" >> $GITHUB_OUTPUT
              elif [[ "$BRANCH_REF" == "refs/heads/prod" ]]; then
                echo "RELEASE_TAG=release-${TAG_NAME}" >> $GITHUB_OUTPUT
              elif [[ "$BRANCH_REF" == "refs/heads/test" ]]; then
                echo "RELEASE_TAG=beta-${TAG_NAME}" >> $GITHUB_OUTPUT
              else
                echo "RELEASE_TAG=alpha-${TAG_NAME}" >> $GITHUB_OUTPUT
              fi
            elif [ "${{ github.event_name }}" == "push" ]; then
              echo "RELEASE_TAG=pushed-into-${{ github.ref_name }}" >> $GITHUB_OUTPUT
            elif [ "${{ github.event_name }}" == "pull_request" ]; then
              echo "RELEASE_TAG=merged-into-${{ github.base.ref }}" >> $GITHUB_OUTPUT
            else
              echo "RELEASE_TAG=manual-trigger" >> $GITHUB_OUTPUT
            fi
  
            echo "IMAGE_TAG=$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      # Add approval check for protected branches
      - name: Check deployment approval
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/prod'
        run: |
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "Deployments to master/prod require manual approval via workflow_dispatch"
            exit 1
          fi

      - name: Build and push image to ACR
        run: |
          az acr build --registry ${{ env.ACR_NAME }} \
            --image ${{ steps.set_deployment_info.outputs.CONTAINER_NAME }}:${{ steps.set_deployment_info.outputs.IMAGE_TAG }} \
            --file Dockerfile .
      
      # Add deployment verification for master/prod
      - name: Pre-deployment verification
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/prod'
        run: |
          echo "Performing pre-deployment verification checks..."
          # Add your verification logic here
          # Example: Check if required secrets exist
          if [[ -z "${{ secrets.AZURE_CREDENTIALS }}" ]]; then
            echo "Missing required credentials"
            exit 1
          fi

      - name: Update Azure Container App
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --container-name ${{ steps.set_deployment_info.outputs.CONTAINER_NAME }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ steps.set_deployment_info.outputs.CONTAINER_NAME }}:${{ steps.set_deployment_info.outputs.IMAGE_TAG }} \
            --set-env-vars \
              RELEASE_TAG=${{ steps.set_deployment_info.outputs.RELEASE_TAG }} \
              STAGE=${{ steps.set_deployment_info.outputs.STAGE }} \
              PYTHONUNBUFFERED=1 \
              BOT_TOKEN=secretref:${{ steps.set_deployment_info.outputs.BOT_TOKEN_SECRET }}

      # Add post-deployment verification
      - name: Verify deployment
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/prod'
        run: |
          echo "Verifying deployment..."
          # Add deployment verification logic
          # Example: Check if the container app is healthy
          HEALTH_CHECK_URL="https://${{ env.CONTAINER_APP_NAME }}.azurecontainerapps.io/health"
          for i in {1..5}; do
            if curl -s -f $HEALTH_CHECK_URL; then
              echo "Deployment verified successfully"
              exit 0
            fi
            sleep 30
          done
          echo "Deployment verification failed"
          exit 1

          
      - name: Final Variables Summary
        run: |
          echo "=== FINAL WORKFLOW VARIABLES SUMMARY ==="
          echo "Environment Variables:"
          echo "  ACR_NAME: ${{ env.ACR_NAME }}"
          echo "  RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}"
          echo "  CONTAINER_APP_NAME: ${{ env.CONTAINER_APP_NAME }}"
          echo ""
          echo "Deployment Info Variables:"
          echo "  Stage: ${{ steps.set_deployment_info.outputs.STAGE }}"
          echo "  Container Name: ${{ steps.set_deployment_info.outputs.CONTAINER_NAME }}"
          echo "  Release Tag: ${{ steps.set_deployment_info.outputs.RELEASE_TAG }}"
          echo "  Image Tag: ${{ steps.set_deployment_info.outputs.IMAGE_TAG }}"
          echo "  Deployment Slot: ${{ steps.set_deployment_info.outputs.DEPLOYMENT_SLOT }}"
          echo ""
          echo "Container Image:"
          echo "  Full Image Path: ${{ env.ACR_NAME }}.azurecr.io/${{ steps.set_deployment_info.outputs.CONTAINER_NAME }}:${{ steps.set_deployment_info.outputs.IMAGE_TAG }}"